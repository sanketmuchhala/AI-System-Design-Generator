!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const r of e)if("childList"===r.type)for(const e of r.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class e{constructor(){this.currentMermaidCode="",this.isGenerating=!1,this.liveUpdateTimeout=null,this.zoomLevel=1,this.isDragging=!1,this.dragStart={x:0,y:0},this.panOffset={x:0,y:0},this.currentTheme=localStorage.getItem("theme")||"light",this.init()}init(){this.initializeTheme(),this.setupEventListeners(),this.initializeMermaid(),this.loadExamples(),this.testMermaidBasic()}async testMermaidBasic(){try{const e="graph TD\n    A[Test] --\x3e B[Working]";await mermaid.render("test-basic",e),console.log("✅ Mermaid is working correctly")}catch(e){console.error("❌ Mermaid initialization failed:",e)}}setupEventListeners(){document.getElementById("generateBtn").addEventListener("click",this.generateDiagram.bind(this)),document.getElementById("clearBtn").addEventListener("click",this.clearAll.bind(this)),document.getElementById("mermaidCodeEditor").addEventListener("input",this.handleCodeChange.bind(this)),document.getElementById("mermaidCodeEditor").addEventListener("keydown",this.handleCodeKeydown.bind(this)),document.getElementById("copyCodeBtn").addEventListener("click",this.copyMermaidCode.bind(this)),document.getElementById("formatCodeBtn").addEventListener("click",this.formatMermaidCode.bind(this)),document.getElementById("downloadSvgBtn").addEventListener("click",()=>this.downloadDiagram("svg")),document.getElementById("downloadPngBtn").addEventListener("click",()=>this.downloadDiagram("png")),document.getElementById("refreshDiagramBtn").addEventListener("click",this.refreshDiagram.bind(this)),document.getElementById("zoomInBtn").addEventListener("click",()=>this.zoom(1.2)),document.getElementById("zoomOutBtn").addEventListener("click",()=>this.zoom(.8)),document.getElementById("zoomResetBtn").addEventListener("click",()=>this.resetZoom()),this.setupPanControls(),document.getElementById("themeToggle").addEventListener("click",this.toggleTheme.bind(this)),document.getElementById("systemDescription").addEventListener("keydown",e=>{e.ctrlKey&&"Enter"===e.key&&this.generateDiagram()})}initializeMermaid(){this.updateMermaidTheme()}handleCodeChange(e){const t=e.target.value;this.currentMermaidCode=t,this.liveUpdateTimeout&&clearTimeout(this.liveUpdateTimeout),this.liveUpdateTimeout=setTimeout(()=>{t.trim()&&this.isValidMermaidCode(t)&&this.renderDiagramLive(t)},1e3)}handleCodeKeydown(e){if("Tab"===e.key){e.preventDefault();const t=e.target,r=t.selectionStart,i=t.selectionEnd;t.value=t.value.substring(0,r)+"    "+t.value.substring(i),t.selectionStart=t.selectionEnd=r+4,this.handleCodeChange(e)}e.ctrlKey&&"Enter"===e.key&&(e.preventDefault(),this.refreshDiagram())}async renderDiagramLive(e){try{const t=document.getElementById("diagramContainer"),r="live-diagram-"+Date.now(),{svg:i}=await mermaid.render(r,e);t.innerHTML=i;const n=t.querySelector("svg");if(n){if(n.removeAttribute("width"),n.removeAttribute("height"),!n.getAttribute("viewBox")){const e=n.getBBox();n.setAttribute("viewBox",`${e.x} ${e.y} ${e.width} ${e.height}`)}n.style.maxWidth="none",n.style.height="auto",n.style.display="block"}this.updateZoom()}catch(t){console.warn("Live update failed:",t.message)}}async refreshDiagram(){const e=document.getElementById("mermaidCodeEditor").value.trim();if(e)try{await this.renderDiagram(e)}catch(t){this.showError("Failed to render diagram: "+t.message)}}zoom(e){this.zoomLevel*=e,this.zoomLevel=Math.max(.1,Math.min(5,this.zoomLevel)),this.updateZoom()}resetZoom(){this.zoomLevel=1,this.panOffset={x:0,y:0},this.updateZoom()}updateZoom(){const e=document.getElementById("diagramContainer"),t=document.getElementById("zoomLevel");e.style.transform=`translate(${this.panOffset.x}px, ${this.panOffset.y}px) scale(${this.zoomLevel})`,t.textContent=`${Math.round(100*this.zoomLevel)}%`}setupPanControls(){const e=document.getElementById("diagramContainer");e.addEventListener("mousedown",this.startPan.bind(this)),e.addEventListener("mousemove",this.doPan.bind(this)),e.addEventListener("mouseup",this.stopPan.bind(this)),e.addEventListener("mouseleave",this.stopPan.bind(this)),e.addEventListener("wheel",e=>{e.preventDefault();const t=e.deltaY<0?1.1:.9;this.zoom(t)})}startPan(e){e.target.closest("svg")&&(this.isDragging=!0,this.dragStart={x:e.clientX-this.panOffset.x,y:e.clientY-this.panOffset.y},e.preventDefault())}doPan(e){this.isDragging&&(this.panOffset={x:e.clientX-this.dragStart.x,y:e.clientY-this.dragStart.y},this.updateZoom())}stopPan(){this.isDragging=!1}initializeTheme(){document.documentElement.setAttribute("data-theme",this.currentTheme)}toggleTheme(){this.currentTheme="light"===this.currentTheme?"dark":"light",document.documentElement.setAttribute("data-theme",this.currentTheme),localStorage.setItem("theme",this.currentTheme),this.updateMermaidTheme()}updateMermaidTheme(){const e="dark"===this.currentTheme?"base":"default",t="dark"===this.currentTheme?{primaryColor:"#8b5cf6",primaryTextColor:"#ffffff",primaryBorderColor:"#a855f7",lineColor:"#c4b5fd",secondaryColor:"#1e293b",tertiaryColor:"#334155",background:"#000000",mainBkg:"#0a0a0a",secondBkg:"#111111",tertiaryBkg:"#1e293b",primaryBorderColor:"#c4b5fd",primaryTextColor:"#ffffff",lineColor:"#8b5cf6",textColor:"#ffffff",edgeLabelBackground:"#0a0a0a",nodeBorder:"#a855f7",clusterBkg:"#1e293b",clusterBorder:"#334155",defaultLinkColor:"#8b5cf6",titleColor:"#ffffff",fontFamily:"Geist, sans-serif"}:{primaryColor:"#6366f1",primaryTextColor:"#0f172a",primaryBorderColor:"#4f46e5",lineColor:"#6366f1",secondaryColor:"#f8fafc",tertiaryColor:"#e2e8f0",background:"#ffffff",mainBkg:"#ffffff",secondBkg:"#f8fafc",tertiaryBkg:"#f1f5f9",primaryBorderColor:"#6366f1",primaryTextColor:"#0f172a",lineColor:"#6366f1",textColor:"#0f172a",edgeLabelBackground:"#ffffff",nodeBorder:"#6366f1",clusterBkg:"#f8fafc",clusterBorder:"#e2e8f0",defaultLinkColor:"#6366f1",titleColor:"#0f172a",fontFamily:"Geist, sans-serif"};mermaid.initialize({startOnLoad:!1,theme:e,themeVariables:t,securityLevel:"loose",deterministicIds:!1,logLevel:"error",flowchart:{useMaxWidth:!1,htmlLabels:!0,curve:"basis",padding:20},sequence:{useMaxWidth:!1,wrap:!0,showSequenceNumbers:!0,diagramMarginX:20,diagramMarginY:20},class:{useMaxWidth:!1},state:{useMaxWidth:!1},er:{useMaxWidth:!1},pie:{useMaxWidth:!1},gantt:{useMaxWidth:!1,fontSize:14}}),this.currentMermaidCode&&setTimeout(()=>{this.renderDiagram(this.currentMermaidCode).catch(console.warn)},100)}showError(e){const t=document.querySelector(".error-section");document.getElementById("errorText").textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},1e4)}hideError(){document.querySelector(".error-section").style.display="none"}loadExamples(){this.examples={microservices:"Microservices e-commerce platform with API gateway, user service, product service, order service, payment gateway, Redis cache, PostgreSQL databases, and load balancer. Include authentication service, notification service, and monitoring system.",chat:"Real-time chat application with WebSocket connections, message queues (Redis), user authentication service, message persistence (MongoDB), presence tracking, push notifications, and CDN for file sharing. Include rate limiting and message encryption.",pipeline:"Data pipeline system with data ingestion layer (Kafka), stream processing workers (Apache Spark), data lake (S3), analytics engine, ETL processes, data warehouse, real-time dashboard, and monitoring alerts.",cicd:"CI/CD pipeline with Git repository, webhook triggers, build servers (Jenkins), automated testing environments, code quality gates, artifact repository, staging environment, production deployment, and rollback mechanisms."}}async generateDiagram(){if(console.log("Generate diagram called"),this.isGenerating)return void console.log("Already generating, skipping");const e=document.getElementById("systemDescription");if(!e)return console.error("Required elements not found"),void this.showError("Interface elements not found. Please refresh the page.");let t=e.value.trim();console.log("Description:",t?"Present":"Empty");t||(t="Microservices e-commerce platform with API gateway, user service, product service, order service, payment gateway, Redis cache, PostgreSQL databases, and load balancer. Include authentication service, notification service, and monitoring system.",e.value=t),this.isGenerating=!0,this.hideError(),this.setGeneratingState(!0);try{const e=await this.generateMermaidCode(t,"AIzaSyC_nd55MXU_iXGsnOheV4dBaqfqqzOmQ6Q");await this.renderDiagram(e)}catch(r){console.error("Generation error:",r),this.showError(r.message||"Failed to generate diagram. Please try again.")}finally{this.isGenerating=!1,this.setGeneratingState(!1)}}setGeneratingState(e){const t=document.getElementById("generateBtn"),r=t.querySelector(".btn-text"),i=t.querySelector(".loading-spinner");e?(t.disabled=!0,r.style.display="none",i.style.display="inline-block"):(t.disabled=!1,r.style.display="inline-block",i.style.display="none")}async generateMermaidCode(e,t){var r;const i=`You are a system architecture expert. Generate ONLY valid Mermaid diagram code for the described system. \n\nRules:\n1. Choose the most appropriate Mermaid diagram type (flowchart, sequence, class, state, etc.)\n2. Use proper Mermaid syntax and formatting\n3. Focus on: components, data flow, relationships, and interactions\n4. Make diagrams clear and professional\n5. Use meaningful node names and labels\n6. Output ONLY the Mermaid code without explanations, markdown formatting, or code blocks\n7. Ensure the diagram is comprehensive but not overcomplicated\n\nFor flowcharts, use these node types:\n- Rectangle nodes: [Service Name]\n- Rounded nodes: (Database)\n- Circle nodes: ((Cache))\n- Diamond nodes: {Decision}\n- Hexagon nodes: {{External API}}\n\nSystem description: ${e}`,n=await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key="+t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:i}]}],generationConfig:{temperature:.3,topK:40,topP:.95,maxOutputTokens:2048}})});if(!n.ok){const e=await n.json().catch(()=>({}));throw 400===n.status?new Error("Invalid API key or request. Please check your Gemini API key."):429===n.status?new Error("API rate limit exceeded. Please wait a moment and try again."):new Error(`API error: ${(null==(r=e.error)?void 0:r.message)||"Unknown error"}`)}const a=await n.json();if(!a.candidates||!a.candidates[0]||!a.candidates[0].content)throw new Error("Invalid response from Gemini API");let o=a.candidates[0].content.parts[0].text.replace(/```mermaid\n?/gi,"").replace(/```\n?/g,"").trim();if(!this.isValidMermaidCode(o))throw new Error("Generated code is not valid Mermaid syntax");return o}isValidMermaidCode(e){const t=e.trim();if(!t||t.length<5)return!1;return[/^graph\s+(TD|TB|BT|RL|LR)/i,/^flowchart\s+(TD|TB|BT|RL|LR)/i,/^sequenceDiagram/i,/^classDiagram/i,/^stateDiagram/i,/^erDiagram/i,/^pie\s+title/i,/^gantt/i,/^gitgraph/i,/^journey/i].some(e=>e.test(t))}async renderDiagram(e){this.currentMermaidCode=e;document.getElementById("mermaidCodeEditor").value=e;const t=document.getElementById("diagramContainer");t.innerHTML='<div class="diagram-loading">Rendering diagram...</div>';try{const r="diagram-"+Date.now(),{svg:i}=await mermaid.render(r,e);if(!i)throw new Error("Failed to generate SVG from Mermaid code");t.innerHTML=i,this.zoomLevel=1,this.panOffset={x:0,y:0};const n=t.querySelector("svg");if(n){if(n.removeAttribute("width"),n.removeAttribute("height"),!n.getAttribute("viewBox")){const e=n.getBBox();n.setAttribute("viewBox",`${e.x} ${e.y} ${e.width} ${e.height}`)}n.style.maxWidth="none",n.style.height="auto",n.style.display="block"}this.updateZoom()}catch(r){throw console.error("Mermaid rendering error:",r),t.innerHTML=`\n                <div class="diagram-error">\n                    <p>❌ Failed to render diagram</p>\n                    <p>The generated Mermaid code may have syntax errors.</p>\n                    <p>Please check the code in the "Mermaid Code" tab.</p>\n                    <details>\n                        <summary>Error Details</summary>\n                        <pre>${r.message}</pre>\n                    </details>\n                </div>\n            `,new Error("Failed to render diagram: "+r.message)}}formatMermaidCode(){const e=document.getElementById("mermaidCodeEditor");let t=e.value;if(!t.trim())return;const r=t.split("\n");let i=[],n=0;for(let o of r){const e=o.trim();if(!e){i.push("");continue}(e.includes("}")||e.includes("end"))&&(n=Math.max(0,n-1));const t="    ".repeat(n);i.push(t+e),(e.includes("{")||e.startsWith("subgraph")||e.startsWith("class"))&&n++}const a=i.join("\n");e.value=a,this.currentMermaidCode=a,this.refreshDiagram()}async copyMermaidCode(){const e=document.getElementById("mermaidCodeEditor").value;if(e.trim())try{await navigator.clipboard.writeText(e);const t=document.getElementById("copyCodeBtn"),r=t.textContent;t.textContent="✅ Copied!",t.style.background="var(--success-color)",t.style.color="white",setTimeout(()=>{t.textContent=r,t.style.background="",t.style.color=""},2e3)}catch(t){console.error("Copy failed:",t),this.showError("Failed to copy code to clipboard")}}async downloadDiagram(e){const t=document.getElementById("diagramContainer").querySelector("svg");if(t)try{"svg"===e?this.downloadSVG(t):"png"===e&&await this.downloadPNG(t)}catch(r){console.error("Download failed:",r),this.showError(`Failed to download ${e.toUpperCase()}`)}else this.showError("No diagram to download")}downloadSVG(e){const t=(new XMLSerializer).serializeToString(e),r=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),i=URL.createObjectURL(r),n=document.createElement("a");n.href=i,n.download="system-diagram.svg",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(i)}async downloadPNG(e){const t=document.createElement("canvas"),r=t.getContext("2d"),i=new Image;return new Promise((n,a)=>{i.onload=()=>{t.width=2*i.width,t.height=2*i.height,r.scale(2,2),r.drawImage(i,0,0),t.toBlob(e=>{const t=URL.createObjectURL(e),r=document.createElement("a");r.href=t,r.download="system-diagram.png",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(t),n()},"image/png")},i.onerror=a;const o=(new XMLSerializer).serializeToString(e),s=new Blob([o],{type:"image/svg+xml;charset=utf-8"}),d=URL.createObjectURL(s);i.src=d})}clearAll(){document.getElementById("systemDescription").value="",document.querySelector(".error-section").style.display="none",this.currentMermaidCode="",document.getElementById("mermaidCodeEditor").value="",document.getElementById("diagramContainer").innerHTML='\n            <div class="diagram-placeholder">\n                <div class="placeholder-content">\n                    <span class="placeholder-icon">⚡</span>\n                    <p>Generate or edit Mermaid code to see your diagram here</p>\n                </div>\n            </div>\n        '}}document.addEventListener("DOMContentLoaded",()=>{new e}),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/service-worker.js").catch(()=>{})});
